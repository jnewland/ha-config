sequence:
- condition: template
  value_template: |
    {{
      states.light |
      selectattr("state", "equalto", "on") |
      selectattr("attributes.notify_action", "equalto", "duck") |
      map(attribute="entity_id") |
      list |
      length > 0
    }}
- service: script.pulse_light
  data_template:
    entity_id: |
      {{
        states.light |
        selectattr("state", "equalto", "on") |
        selectattr("attributes.notify_action", "equalto", "duck") |
        map(attribute="entity_id") |
        join(', ')
      }}
