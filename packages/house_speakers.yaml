group:
  great_room_speakers:
    icon: mdi:speaker
    entities:
      - media_player.living_speakers
      - media_player.kitchen_speakers

template:
  - sensor:
      - name: House speaker source
        unique_id: house_speaker_source_entity_id
        state: >
          {% if is_state('media_player.house', 'playing') %}
            media_player.house
          {% elif is_state('media_player.lounge', 'playing') %}
            media_player.lounge_surround
          {% else %}
            undefined
          {% endif %}

automation:
  - alias: Turn on related speakers
    mode: parallel
    id: 3ba3e202-4fa0-4f94-8f7d-6cf2aeb674c3
    trigger:
      platform: event
      event_type: state_changed
    condition:
      condition: template
      value_template: |
        {{
          trigger.event.data.old_state != None and
          trigger.event.data.new_state.domain == "binary_sensor" and
          is_state(trigger.event.data.new_state.entity_id, "on") and
          trigger.event.data.new_state.attributes.speaker_entity is defined
        }}
    action:
      - service: homeassistant.turn_on
        data:
          entity_id: |
            {{ trigger.event.data.new_state.attributes.speaker_entity }}
  - alias: Turn off related speakers
    mode: parallel
    id: d55dd41d-cd36-4544-8ed1-58b1578ec0ce
    trigger:
      platform: event
      event_type: state_changed
    condition:
      condition: template
      value_template: |
        {{
          trigger.event.data.old_state != None and
          trigger.event.data.new_state.domain == "binary_sensor" and
          is_state(trigger.event.data.new_state.entity_id, "off") and
          trigger.event.data.new_state.attributes.speaker_entity is defined
        }}
    action:
      - service: homeassistant.turn_off
        data:
          entity_id: |
            {{ trigger.event.data.new_state.attributes.speaker_entity }}
  - alias: Group sonos speakers
    mode: parallel
    id: fe8d95bc-f94f-4454-83b0-527b9d403107
    trigger:
      platform: event
      event_type: state_changed
    condition:
      condition: template
      value_template: |
        {{
          trigger.event.data.old_state != None and
          trigger.event.data.new_state.domain == "binary_sensor" and
          is_state(trigger.event.data.new_state.entity_id, "on") and
          trigger.event.data.new_state.attributes.media_player_group_member is defined and
          states('sensor.house_speaker_source') is defined and
          not is_state('sensor.house_speaker_source', 'undefined') and
          not is_state('sensor.house_speaker_source', trigger.event.data.new_state.attributes.media_player_group_member) and
          trigger.event.data.new_state.attributes.media_player_group_member not in state_attr(states('sensor.house_speaker_source'), 'group_members') and
          ( is_state(trigger.event.data.new_state.attributes.media_player_group_member, 'idle') or
            is_state(trigger.event.data.new_state.attributes.media_player_group_member, 'paused') )
        }}
    action:
      - service: media_player.join
        data:
          group_members: |
            {{ trigger.event.data.new_state.attributes.media_player_group_member }}
          entity_id: |
            {{ states('sensor.house_speaker_source') }}
      - service: system_log.write
        data:
          message: >
            at=media_player.join
            group_members={{ trigger.event.data.new_state.attributes.media_player_group_member }}
            entity_id={{ states('sensor.house_speaker_source') }}
          logger: packages.house_speakers
          level: debug
  - alias: Ungroup sonos speakers
    mode: parallel
    id: b301d317-ef17-4285-a2de-a96353d12712
    trigger:
      platform: event
      event_type: state_changed
    condition:
      condition: template
      value_template: |
        {{
          trigger.event.data.old_state != None and
          trigger.event.data.new_state.domain == "binary_sensor" and
          is_state(trigger.event.data.new_state.entity_id, "off") and
          trigger.event.data.new_state.attributes.media_player_group_member is defined
        }}
    action:
      - service: media_player.unjoin
        data: {}
        target:
          entity_id: |
            {{ trigger.event.data.new_state.attributes.media_player_group_member }}
      - service: system_log.write
        data:
          message: >
            at=media_player.unjoin
            entity_id={{ trigger.event.data.new_state.attributes.media_player_group_member }}
          logger: packages.house_speakers
          level: debug
  - alias: Pause house speakers when tvs are playing
    mode: parallel
    id: b6ba810d-20a9-4d2e-8252-f6afefd9824e
    trigger:
      - platform: state
        entity_id: media_player.lounge
        to: playing
      - platform: state
        entity_id: media_player.bedroom
        to: playing
    condition:
      - condition: state
        entity_id: media_player.house
        state: playing
    action:
      - service: media_player.media_pause
        target:
          entity_id: media_player.house
      - condition: template
        value_template: |
          {{ not is_state('sensor.house_speaker_source', 'undefined') }}
      - service: media_player.join
        data:
          group_members: media_player.house
          entity_id: |
            {{ states('sensor.house_speaker_source') }}
